{% extends "menu.html" %}

{% block content %}

<main class="container py-5 mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">

            <form action="/create_record/" method="POST" class="card card-body">
                {% csrf_token %}
                <h3 class="text-center">Registrar Nova Ocorrência</h3>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="caller_name" class="form-label">Nome do solicitante</label>
                        <input type="text" class="form-control" name="caller_name" id="caller_name">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="caller_phone" class="form-label">Telefone</label>
                        <input type="text" class="form-control" name="caller_phone" id="caller_phone"
                               oninput="formatPhone()" maxlength="15">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="caller_zip_code" class="form-label">CEP</label>
                        <input type="text" class="form-control" name="caller_zip_code" id="caller_zip_code"
                               onblur="fetchAddressData()" oninput="formatZipCode()" maxlength="9">
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="caller_neighborhood" class="form-label">Bairro</label>
                        <input type="text" class="form-control" name="caller_neighborhood" id="caller_neighborhood">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="caller_street" class="form-label">Rua</label>
                        <input type="text" class="form-control" name="caller_street" id="caller_street">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="caller_house_number" class="form-label">Número</label>
                        <input type="text" class="form-control" name="caller_house_number" id="caller_house_number">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 form-check">
                        <input class="form-check-input" type="checkbox" name="is_caller_part_of" value="true" id="is_caller_part_of">
                        <label class="form-check-label" for="is_caller_part_of">
                            O solicitante é parte da ocorrência?
                        </label>
                    </div>

                    <div class="col-md-6 form-check">
                        <input class="form-check-input" type="checkbox" name="is_caller_wating" value="true" id="is_caller_wating">
                        <label class="form-check-label" for="is_caller_wating">
                            Está aguardando no local?
                        </label>
                    </div>
                </div>

                <div class="mb-3 mt-3">
                    <label for="fact_date" class="form-label">Data/hora do fato</label>
                    <input type="datetime-local" class="form-control" name="fact_date" id="fact_date">
                </div>

                <label class="text-center pb-3 text-success">{{ success }}</label>
                <label class="text-center pb-3 text-danger">{{ error }}</label>

                <button type="submit" class="btn btn-primary">Registrar</button>
            </form>
        </div>
    </div>
</main>

<!--Scripts para buscar endereço e tratar as entradas dos campos de cep e telefone-->
<script>

    function fetchAddressData() {
        const zipCode = document.getElementById("caller_zip_code").value.replace(/\D/g, '');

        if (zipCode.length === 8) {
            fetch(`https://viacep.com.br/ws/${zipCode}/json/`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById("caller_neighborhood").value = data.bairro || "Não Informado";
                        document.getElementById("caller_street").value = data.logradouro || "Não Informado";
                    } else {
                        alert("CEP não encontrado.");
                    }
                })
                .catch(error => console.error("Erro ao buscar endereço:", error));
        }
    }

    function formatZipCode() {
        const zipInput = document.getElementById("caller_zip_code");
        const zipValue = zipInput.value.replace(/\D/g, '');
        
        if (zipValue.length > 5) {
            zipInput.value = `${zipValue.slice(0, 5)}-${zipValue.slice(5, 8)}`;
        } else {
            zipInput.value = zipValue;
        }
    }

    function formatPhone() {
        const phoneInput = document.getElementById("caller_phone");
        let phoneValue = phoneInput.value.replace(/\D/g, '');

        if (phoneValue.length === 0) {
            phoneInput.value = "";
        } else if (phoneValue.length <= 2) {
            phoneInput.value = `(${phoneValue}`;
        } else if (phoneValue.length <= 6) {
            phoneInput.value = `(${phoneValue.slice(0, 2)}) ${phoneValue.slice(2)}`;
        } else if (phoneValue.length <= 10) {
            phoneInput.value = `(${phoneValue.slice(0, 2)}) ${phoneValue.slice(2, 6)}-${phoneValue.slice(6)}`;
        } else {
            phoneInput.value = `(${phoneValue.slice(0, 2)}) ${phoneValue.slice(2, 7)}-${phoneValue.slice(7, 11)}`;
        }
    }
</script>

{% endblock %}
